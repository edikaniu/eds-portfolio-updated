name: Dependency Updates

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    name: Update Dependencies
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Check for outdated packages
        run: |
          npm outdated --json > outdated.json || true
          cat outdated.json

      - name: Update patch and minor versions
        run: |
          npm update

      - name: Check for major updates
        run: |
          npx npm-check-updates --target minor --jsonUpgraded > minor-updates.json
          npx npm-check-updates --target major --jsonUpgraded > major-updates.json

      - name: Install updated dependencies
        run: npm install --legacy-peer-deps

      - name: Run tests with updated dependencies
        run: |
          npm run test:setup
          npm run test:unit
          npm run type-check
          npm run lint

      - name: Check bundle size impact
        run: |
          npm run build
          npm run analyze:size || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'ðŸ”„ Automated Dependency Updates'
          body: |
            This is an automated pull request to update dependencies.
            
            ## Changes
            - Updated patch and minor versions
            - Verified tests pass with new versions
            - Checked bundle size impact
            
            Please review the changes and merge if appropriate.
            
            ## Testing
            - [x] Unit tests pass
            - [x] Type checking passes
            - [x] Linting passes
            - [x] Build succeeds
            
            **Note**: Major version updates require manual review.
          branch: automated/dependency-updates
          delete-branch: true

  security-updates:
    runs-on: ubuntu-latest
    name: Security Updates
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Check for security vulnerabilities
        run: |
          npm audit --audit-level=moderate --json > security-audit.json || true
          cat security-audit.json

      - name: Fix security issues automatically
        run: |
          npm audit fix --force || true

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run tests after security fixes
        run: |
          npm run test:setup
          npm run test:unit
          npm run type-check

      - name: Create security update PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'security: fix vulnerable dependencies'
          title: 'ðŸ”’ Security: Fix Vulnerable Dependencies'
          body: |
            This is an automated pull request to fix security vulnerabilities.
            
            ## Security Updates Applied
            - Applied automatic security fixes
            - Updated vulnerable packages
            - Verified tests still pass
            
            **Priority**: High - Security fixes should be merged promptly.
            
            ## Testing
            - [x] Unit tests pass
            - [x] Type checking passes
            - [x] Build succeeds
            
            Please review and merge to address security vulnerabilities.
          branch: automated/security-updates
          delete-branch: true
          labels: security,automated